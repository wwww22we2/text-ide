<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ Todo List - ä»»åŠ¡ç®¡ç†</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-tasks"></i> Todo List</h1>
            <div class="stats" id="stats">
                <div class="stat-item">
                    <span class="stat-number" id="total">0</span>
                    <span class="stat-label">æ€»ä»»åŠ¡</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="completed">0</span>
                    <span class="stat-label">å·²å®Œæˆ</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="pending">0</span>
                    <span class="stat-label">å¾…å®Œæˆ</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="completion-rate">0%</span>
                    <span class="stat-label">å®Œæˆç‡</span>
                </div>
            </div>
        </header>

        <!-- Flash æ¶ˆæ¯ -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">
                            <i class="fas fa-info-circle"></i>
                            {{ message }}
                            <button class="close-flash">&times;</button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- æ·»åŠ ä»»åŠ¡è¡¨å• -->
        <div class="add-todo-form">
            <form method="POST" class="todo-form">
                <div class="form-group">
                    <input type="text" 
                           name="content" 
                           placeholder="è¯·è¾“å…¥æ–°ä»»åŠ¡..." 
                           class="todo-input" 
                           required 
                           maxlength="200">
                    <select name="priority" class="priority-select">
                        <option value="low">ğŸŸ¢ ä½ä¼˜å…ˆçº§</option>
                        <option value="medium" selected>ğŸŸ¡ ä¸­ä¼˜å…ˆçº§</option>
                        <option value="high">ğŸ”´ é«˜ä¼˜å…ˆçº§</option>
                    </select>
                    <button type="submit" class="add-btn">
                        <i class="fas fa-plus"></i> æ·»åŠ ä»»åŠ¡
                    </button>
                </div>
            </form>
        </div>

        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="todo-list">
            {% if todos %}
                <!-- æ¸…ç©ºæ‰€æœ‰å†å²ä¿¡æ¯æŒ‰é’® -->
                <div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <form method="POST" action="{{ url_for('clear_all') }}" style="display: inline;">
                        <button type="submit" 
                                class="btn btn-danger" 
                                style="padding: 10px 20px; font-size: 0.9rem;"
                                onclick="return confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†åˆ é™¤æ‰€æœ‰ä»»åŠ¡å†å²ä¿¡æ¯ï¼\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')">
                            <i class="fas fa-trash-alt"></i> æ¸…ç©ºæ‰€æœ‰å†å²ä¿¡æ¯
                        </button>
                    </form>
                </div>
                {% for todo in todos %}
                    <div class="todo-item {{ 'completed' if todo.completed else '' }} priority-{{ todo.priority }}" data-todo-id="{{ todo.id }}">
                        <div class="todo-content">
                            <div class="todo-text">
                                {% if todo.completed %}
                                    <del>{{ todo.content }}</del>
                                {% else %}
                                    {{ todo.content }}
                                {% endif %}
                            </div>
                            <div class="todo-meta">
                                <span class="priority-badge priority-{{ todo.priority }}">
                                    {% if todo.priority == 'high' %}ğŸ”´ é«˜ä¼˜å…ˆçº§
                                    {% elif todo.priority == 'medium' %}ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
                                    {% else %}ğŸŸ¢ ä½ä¼˜å…ˆçº§
                                    {% endif %}
                                </span>
                                <div class="time-info">
                                    <span class="created-time">
                                        <i class="fas fa-clock"></i> åˆ›å»º: {{ todo.created_at | format_datetime }}
                                        <small>({{ todo.created_at | relative_time }})</small>
                                    </span>
                                    {% if todo.completed_at %}
                                        <span class="completed-time">
                                            <i class="fas fa-check-circle"></i> å®Œæˆ: {{ todo.completed_at | format_datetime }}
                                            <small>({{ todo.completed_at | relative_time }})</small>
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="todo-actions">
                            {% if not todo.completed %}
                                <a href="{{ url_for('complete', todo_id=todo.id) }}" 
                                   class="btn btn-success" 
                                   title="æ ‡è®°ä¸ºå®Œæˆ">
                                    <i class="fas fa-check"></i>
                                </a>
                                <a href="{{ url_for('edit', todo_id=todo.id) }}" 
                                   class="btn btn-info" 
                                   title="ç¼–è¾‘ä»»åŠ¡">
                                    <i class="fas fa-edit"></i>
                                </a>
                            {% else %}
                                <a href="{{ url_for('uncomplete', todo_id=todo.id) }}" 
                                   class="btn btn-warning" 
                                   title="æ ‡è®°ä¸ºæœªå®Œæˆ">
                                    <i class="fas fa-undo"></i>
                                </a>
                            {% endif %}
                            <a href="{{ url_for('delete', todo_id=todo.id) }}" 
                               class="btn btn-danger" 
                               title="åˆ é™¤ä»»åŠ¡"
                               onclick="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>è¿˜æ²¡æœ‰ä»»åŠ¡</h3>
                    <p>æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å¼€å§‹ç®¡ç†ä½ çš„å¾…åŠäº‹é¡¹å§ï¼</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        function loadStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('total').textContent = data.total;
                    document.getElementById('completed').textContent = data.completed;
                    document.getElementById('pending').textContent = data.pending;
                    document.getElementById('completion-rate').textContent = data.completion_rate + '%';
                })
                .catch(error => console.error('Error loading stats:', error));
        }

        // å…³é—­flashæ¶ˆæ¯
        document.querySelectorAll('.close-flash').forEach(button => {
            button.addEventListener('click', function() {
                this.parentElement.style.display = 'none';
            });
        });

        // è‡ªåŠ¨éšè—flashæ¶ˆæ¯
        setTimeout(() => {
            document.querySelectorAll('.flash-message').forEach(msg => {
                msg.style.opacity = '0';
                setTimeout(() => msg.style.display = 'none', 300);
            });
        }, 5000);

        // é¡µé¢åŠ è½½æ—¶åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', loadStats);

        // å®æ—¶æ›´æ–°ç›¸å¯¹æ—¶é—´
        function updateRelativeTimes() {
            // å‘åç«¯è¯·æ±‚æ›´æ–°ç›¸å¯¹æ—¶é—´
            fetch('/api/times')
                .then(response => response.json())
                .then(data => {
                    // æ›´æ–°æ¯ä¸ªä»»åŠ¡çš„ç›¸å¯¹æ—¶é—´
                    Object.keys(data).forEach(todoId => {
                        const timeInfo = data[todoId];
                        
                        // æ›´æ–°åˆ›å»ºæ—¶é—´
                        const createdTimeElement = document.querySelector(`[data-todo-id="${todoId}"] .created-time small`);
                        if (createdTimeElement && timeInfo.created_relative) {
                            createdTimeElement.textContent = `(${timeInfo.created_relative})`;
                        }
                        
                        // æ›´æ–°å®Œæˆæ—¶é—´
                        const completedTimeElement = document.querySelector(`[data-todo-id="${todoId}"] .completed-time small`);
                        if (completedTimeElement && timeInfo.completed_relative) {
                            completedTimeElement.textContent = `(${timeInfo.completed_relative})`;
                        }
                    });
                })
                .catch(error => console.error('Error updating times:', error));
        }

        // æ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ç›¸å¯¹æ—¶é—´
        setInterval(updateRelativeTimes, 5 * 60 * 1000);

        // å¢å¼ºæ—¶é—´æ˜¾ç¤ºçš„äº¤äº’æ€§
        document.querySelectorAll('.time-info small').forEach(element => {
            element.addEventListener('mouseover', function() {
                this.style.opacity = '1';
                this.style.transform = 'scale(1.05)';
            });
            element.addEventListener('mouseout', function() {
                this.style.opacity = '0.7';
                this.style.transform = 'scale(1)';
            });
        });

        // ä¸ºå®Œæˆçš„ä»»åŠ¡æ·»åŠ åº†ç¥åŠ¨ç”»
        document.querySelectorAll('.todo-item.completed').forEach(item => {
            item.style.transform = 'scale(0.98)';
            item.style.opacity = '0.9';
        });
    </script>
</body>
</html> 